<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Ultimate Web LaTeX IDE</title>
    <meta name="description" content="A professional web LaTeX IDE with a file explorer, resizable panes, and multiple compiler engines.">
    <meta name="author" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        :root {
            --bg-color: #fff; --text-color: #333; --border-color: #ddd; --toolbar-bg: #fff; --editor-bg: #282c34;
            --primary-color: #007bff; --secondary-color: #28a745; --resizer-color: #ccc;
        }
        body.dark-mode {
            --bg-color: #2d323b; --text-color: #f1f1f1; --border-color: #444; --toolbar-bg: #353a44; --editor-bg: #21252b;
            --resizer-color: #555;
        }
        body, html { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: var(--bg-color); color: var(--text-color); height: 100%; display: flex; flex-direction: column; }
        
        .toolbar { display: flex; align-items: center; padding: 8px 15px; background-color: var(--toolbar-bg); border-bottom: 1px solid var(--border-color); flex-shrink: 0; gap: 12px; }
        .toolbar-group { display: flex; align-items: center; gap: 8px; }
        .toolbar button, .toolbar select { padding: 6px 10px; font-size: 14px; border: 1px solid var(--border-color); border-radius: 5px; background-color: var(--bg-color); color: var(--text-color); cursor: pointer; }
        .toolbar button:hover, .toolbar select:hover { background-color: rgba(0,0,0,0.1); }
        #compile-btn { background-color: var(--secondary-color); color: white; font-weight: bold; }
        #compile-btn:hover { background-color: #218838; }
        #compile-btn:disabled { background-color: #aaa; cursor: not-allowed; }

        .main-container { display: flex; flex-grow: 1; min-height: 0; }
        
        #file-explorer { width: 200px; padding: 10px; border-right: 1px solid var(--border-color); overflow-y: auto; flex-shrink: 0; }
        #file-explorer ul { list-style-type: none; padding-left: 15px; margin: 0; }
        #file-explorer li { padding: 4px 0; cursor: pointer; }
        #file-explorer .file:hover { background-color: rgba(0,0,0,0.1); }
        #file-explorer .file.active { background-color: var(--primary-color); color: white; }
        #file-explorer .folder { font-weight: bold; }

        .resizer { width: 5px; background: var(--resizer-color); cursor: col-resize; flex-shrink: 0; }
        .resizer:hover { background: var(--primary-color); }

        .editor-pane { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        #editor { flex: 1; width: 100%; }
        .controls { padding: 10px; background-color: var(--bg-color); border-top: 1px solid var(--border-color); flex-shrink: 0; }
        .console-header { cursor: pointer; user-select: none; padding: 5px 8px; background-color: rgba(0,0,0,0.05); border-radius: 4px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        pre#console { white-space: pre-wrap; max-height: 150px; overflow-y: scroll; background-color: #282c34; color: #abb2bf; padding: 8px; font-size: 13px; margin-top: 5px; }
        
        .pdf-pane { flex: 1; overflow: hidden; }
        #pdfbox { height: 100%; width: 100%; background-color: #525659; }

        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 9999; display: none; justify-content: center; align-items: center; color: white; flex-direction: column; font-size: 1.5em; }
        .spinner { border: 8px solid #f3f3f3; border-top: 8px solid var(--primary-color); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>
    <div class="toolbar">
        <div class="toolbar-group">
            <button onclick="document.getElementById('zip-loader-input').click()">Load Project (.zip)</button>
            <input type="file" id="zip-loader-input" accept=".zip" style="display: none;">
        </div>
        <div class="toolbar-group">
            <button onclick="document.getElementById('file-loader-input').click()">Add Files</button>
            <input type="file" id="file-loader-input" multiple style="display: none;">
        </div>
        <div class="toolbar-group">
            <label for="engine-selector">Engine:</label>
            <select id="engine-selector">
                <option value="pdflatex">pdfLaTeX</option>
                <option value="xetex">XeLaTeX</option>
            </select>
        </div>
        <div class="toolbar-group" style="margin-left: auto;">
            <button id="download-pdf-btn" disabled>Download PDF</button>
            <button id="dark-mode-toggle">Toggle Dark Mode</button>
            <button id="compile-btn" disabled>Initializing...</button>
        </div>
    </div>

    <div class="main-container">
        <div id="file-explorer">
            <p style="margin-top:0; font-size: 14px; color: #888;">Project files will appear here.</p>
        </div>
        <div class="resizer" id="resizer-1"></div>
        <div class="editor-pane">
            <div id="editor">% Welcome to the Ultimate Web LaTeX IDE!</div>
            <div class="controls">
                <div id="console-header" class="console-header"><span>Console Output</span><span>▲</span></div>
                <pre id="console">Engine will be ready shortly...</pre>
            </div>
        </div>
        <div class="resizer" id="resizer-2"></div>
        <div class="pdf-pane"><div id="pdfbox"></div></div>
    </div>

    <div id="loading-overlay"><div class="spinner"></div><span id="loading-text"></span></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.14/ace.js"></script>
    <script src="PdfTeXEngine.js"></script>
    <script src="XeTeXEngine.js"></script>
    <script src="DvipdfmxEngine.js"></script>
<script>
    // --- DOM Elements & State ---
    const elements = {
        editor: ace.edit("editor"), compileBtn: document.getElementById("compile-btn"), console: document.getElementById("console"),
        pdfbox: document.getElementById("pdfbox"), zipLoader: document.getElementById('zip-loader-input'), fileLoader: document.getElementById('file-loader-input'),
        engineSelector: document.getElementById('engine-selector'), loadingOverlay: document.getElementById('loading-overlay'),
        loadingText: document.getElementById('loading-text'), consoleHeader: document.getElementById("console-header"),
        fileExplorer: document.getElementById('file-explorer'), darkModeToggle: document.getElementById('dark-mode-toggle'),
        downloadPdfBtn: document.getElementById('download-pdf-btn')
    };
    const engines = { pdflatex: new PdfTeXEngine(), xetex: new XeTeXEngine(), dvipdfmx: new DvipdfmxEngine() };
    let currentProjectFiles = new Map();
    let mainTexFile = '';
    let lastPdfBlob = null;

    // --- IndexedDB for persistent .sty/.cls files ---
    const DB_NAME = 'LaTeXFilesDB', STORE_NAME = 'StyFilesStore';
    let db;
    function openDb() { return new Promise((resolve, reject) => { const r = indexedDB.open(DB_NAME, 1); r.onerror = () => reject("Error opening IndexedDB."); r.onsuccess = e => { db = e.target.result; resolve(); }; r.onupgradeneeded = e => e.target.result.createObjectStore(STORE_NAME, { keyPath: 'name' }); }); }
    function saveFileToDb(name, data) { if (db) db.transaction([STORE_NAME], 'readwrite').objectStore(STORE_NAME).put({ name, data }); }
    async function loadDbFilesToEngine(engine) { return new Promise(resolve => { if (!db) return resolve(); const r = db.transaction([STORE_NAME], 'readonly').objectStore(STORE_NAME).getAll(); r.onsuccess = e => { e.target.result.forEach(f => engine.writeMemFSFile(f.name, f.data)); console.log(`Loaded ${f.name} from DB`); resolve(); }; });}

    // --- Main Logic ---
    async function init() {
        showLoading("Initializing Engines...");
        elements.editor.setTheme("ace/theme/solarized_dark"); elements.editor.session.setMode("ace/mode/latex"); elements.editor.session.setUseWrapMode(true); elements.editor.setFontSize(16);
        await Promise.all([engines.pdflatex.loadEngine(), engines.xetex.loadEngine(), engines.dvipdfmx.loadEngine(), openDb()]);
        elements.compileBtn.innerHTML = "Compile"; elements.compileBtn.disabled = true; elements.console.innerHTML = "Ready. Load a project to start.";
        hideLoading();
    }
    
    async function loadProjectFiles(files) {
        showLoading("Loading files...");
        for (const file of files) {
            const data = new Uint8Array(await file.arrayBuffer());
            currentProjectFiles.set(file.name, data);
            if (file.name.endsWith('.sty') || file.name.endsWith('.cls')) saveFileToDb(file.name, data);
        }
        updateFileTree();
        const texFiles = [...currentProjectFiles.keys()].filter(k => k.endsWith('.tex'));
        if (!mainTexFile && texFiles.length > 0) {
            mainTexFile = texFiles.find(n => /^(main|master)\.tex$/i.test(n)) || texFiles[0];
            await displayFileInEditor(mainTexFile);
        }
        elements.compileBtn.disabled = false;
        hideLoading();
    }

    async function handleZipLoad(event) {
        const file = event.target.files[0];
        if (!file) return;
        showLoading("Unzipping Project...");
        currentProjectFiles.clear(); mainTexFile = '';
        const zip = await JSZip.loadAsync(file);
        const filesToLoad = [];
        for (const path in zip.files) {
            const entry = zip.files[path];
            if (!entry.dir) {
                const data = await entry.async('uint8array');
                filesToLoad.push(new File([data], path));
            }
        }
        await loadProjectFiles(filesToLoad);
        event.target.value = '';
    }
    
    function updateFileTree() {
        const tree = {};
        currentProjectFiles.forEach((_, path) => {
            let currentLevel = tree;
            path.split('/').forEach((part, index, arr) => {
                if (index === arr.length - 1) currentLevel[part] = 'file';
                else {
                    if (!currentLevel[part]) currentLevel[part] = {};
                    currentLevel = currentLevel[part];
                }
            });
        });
        elements.fileExplorer.innerHTML = buildTreeHtml(tree);
        elements.fileExplorer.querySelectorAll('.file').forEach(el => {
            el.addEventListener('click', (e) => {
                const path = e.target.dataset.path;
                if (path.endsWith('.tex')) mainTexFile = path;
                displayFileInEditor(path);
                document.querySelectorAll('#file-explorer .file.active').forEach(active => active.classList.remove('active'));
                e.target.classList.add('active');
            });
        });
    }

    function buildTreeHtml(tree, path = '') {
        let html = '<ul>';
        Object.entries(tree).sort(([aKey, aVal], [bKey, bVal]) => {
            const aIsDir = typeof aVal === 'object';
            const bIsDir = typeof bVal === 'object';
            if (aIsDir !== bIsDir) return aIsDir ? -1 : 1;
            return aKey.localeCompare(bKey);
        }).forEach(([name, content]) => {
            const fullPath = path ? `${path}/${name}` : name;
            if (typeof content === 'object') {
                html += `<li><span class="folder">📁 ${name}</span>${buildTreeHtml(content, fullPath)}</li>`;
            } else {
                html += `<li><span class="file" data-path="${fullPath}">📄 ${name}</span></li>`;
            }
        });
        return html + '</ul>';
    }

    async function compile() {
        if (!mainTexFile) { alert("Please select a main .tex file from your project."); return; }
        showLoading("Compiling...");
        elements.compileBtn.disabled = true;

        const engineName = elements.engineSelector.value;
        const currentEngine = engines[engineName];
        await loadDbFilesToEngine(currentEngine);

        currentProjectFiles.forEach((data, name) => currentEngine.writeMemFSFile(name, data));
        currentEngine.writeMemFSFile(mainTexFile, new TextEncoder().encode(elements.editor.getValue()));
        currentEngine.setEngineMainFile(mainTexFile);
        
        console.log(`Compiling ${mainTexFile} with ${engineName}...`);
        elements.console.innerHTML = "First pass...";
        let r = await currentEngine.compileLaTeX();
        
        if (r.status === 0 && engineName === 'xetex') {
            elements.console.innerHTML += "\nRunning dvipdfmx...";
            const dvipdfmx = engines.dvipdfmx;
            dvipdfmx.writeMemFSFile("main.xdv", r.pdf);
            r = await dvipdfmx.compilePDF();
        } else {
            elements.console.innerHTML = "Second pass...";
            r = await currentEngine.compileLaTeX();
        }
        
        elements.console.innerHTML = r.log || "No log output.";
        hideLoading(); elements.compileBtn.disabled = false;
        if (r.status === 0) {
            lastPdfBlob = new Blob([r.pdf], { type: 'application/pdf' });
            elements.pdfbox.innerHTML = `<embed src="${URL.createObjectURL(lastPdfBlob)}#toolbar=0&navpanes=1" width="100%" height="100%">`;
            elements.downloadPdfBtn.disabled = false;
        } else {
            elements.pdfbox.innerHTML = `<div style="padding: 20px; color: red;">Compilation failed.</div>`;
            elements.downloadPdfBtn.disabled = true;
        }
    }

    // --- UI Helpers ---
    async function displayFileInEditor(path) {
        const data = currentProjectFiles.get(path);
        if (data) {
            if (/\.(tex|sty|cls|bib)$/.test(path)) {
                elements.editor.setValue(new TextDecoder().decode(data), -1);
            } else {
                elements.editor.setValue(`--- Binary file: ${path} ---`, -1);
            }
        }
    }
    function handleMainFileChange(e) { mainTexFile = e.target.value; displayFileInEditor(mainTexFile); }
    function handleFileLoad(event) { if (event.target.files.length > 0) loadProjectFiles(event.target.files); event.target.value = ''; }
    function toggleConsole() { elements.console.classList.toggle('collapsed'); elements.consoleHeader.querySelector('span:last-child').textContent = elements.console.classList.contains('collapsed') ? '▼' : '▲'; }
    function showLoading(text) { elements.loadingText.textContent = text; elements.loadingOverlay.style.display = 'flex'; }
    function hideLoading() { elements.loadingOverlay.style.display = 'none'; }
    elements.darkModeToggle.addEventListener('click', () => document.body.classList.toggle('dark-mode'));
    elements.downloadPdfBtn.addEventListener('click', () => {
        if (lastPdfBlob) {
            const link = document.createElement('a');
            link.href = URL.createObjectURL(lastPdfBlob);
            link.download = mainTexFile.replace('.tex', '.pdf');
            link.click();
        }
    });

    // --- Resizable Panes Logic ---
    function makeResizable(resizerId, leftPaneId, rightPaneId) {
        const resizer = document.getElementById(resizerId);
        const leftPane = document.getElementById(leftPaneId);
        const rightPane = document.getElementById(rightPaneId);
        let x = 0; let leftWidth = 0;
        const mouseDownHandler = (e) => {
            x = e.clientX; leftWidth = leftPane.getBoundingClientRect().width;
            document.addEventListener('mousemove', mouseMoveHandler); document.addEventListener('mouseup', mouseUpHandler);
        };
        const mouseMoveHandler = (e) => {
            const dx = e.clientX - x; const newLeftWidth = leftWidth + dx;
            const containerWidth = leftPane.parentElement.getBoundingClientRect().width;
            leftPane.style.width = `${newLeftWidth}px`;
            // rightPane.style.width will be handled by flexbox
        };
        const mouseUpHandler = () => { document.removeEventListener('mousemove', mouseMoveHandler); document.removeEventListener('mouseup', mouseUpHandler); };
        resizer.addEventListener('mousedown', mouseDownHandler);
    }
    makeResizable('resizer-1', 'file-explorer', 'editor-pane');
    makeResizable('resizer-2', document.querySelector('.editor-pane').parentElement, 'pdf-pane'); // A bit tricky to get the right elements
    // The above resizer logic is simplified. Let's adjust it to work with flex.
    const resizer1 = document.getElementById('resizer-1');
    const resizer2 = document.getElementById('resizer-2');
    const fileExplorer = document.getElementById('file-explorer');
    const editorPane = document.querySelector('.editor-pane');
    const pdfPane = document.querySelector('.pdf-pane');

    const createDragHandler = (resizer, leftElement, rightElement) => (e) => {
        let x = e.clientX;
        const onMouseMove = (moveEvent) => {
            const dx = moveEvent.clientX - x;
            x = moveEvent.clientX;
            const newLeftWidth = leftElement.offsetWidth + dx;
            const newRightWidth = rightElement.offsetWidth - dx;
            if (newLeftWidth > 50 && newRightWidth > 50) { // minimum width
                 leftElement.style.flex = `0 0 ${newLeftWidth}px`;
                 rightElement.style.flex = `1 1 ${newRightWidth}px`;
            }
        };
        const onMouseUp = () => {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
        };
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
    };
    resizer1.addEventListener('mousedown', createDragHandler(resizer1, fileExplorer, editorPane));
    resizer2.addEventListener('mousedown', createDragHandler(resizer2, editorPane, pdfPane));

    // --- Start ---
    init();
</script>
</body>
</html>